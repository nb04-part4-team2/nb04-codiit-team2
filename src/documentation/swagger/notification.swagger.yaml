# ========================================
# Notification API Swagger Documentation
# ========================================
# 작성일: 2025-01-05
# 도메인: 알림(Notification) 관리
# 총 3개 엔드포인트
#
# 엔드포인트 구조:
# 1. GET    /api/notifications       - 알림 목록 조회
# 2. GET    /api/notifications/sse   - SSE 실시간 알림 연결
# 3. PATCH  /api/notifications/:id/check - 알림 읽음 처리
#
# 특징:
# - SSE(Server-Sent Events)를 통한 실시간 알림 스트리밍
# - 30초마다 keep-alive 전송으로 연결 유지
# - 알림 생성 시 자동으로 SSE를 통해 전송
# ========================================

paths:
  /api/notifications:
    get:
      tags:
        - Notification
      summary: 사용자의 모든 알림 조회
      description: |
        현재 로그인한 사용자의 알림 목록을 페이지네이션으로 조회합니다.

        인증 필요:
        `Bearer 토큰 필수`

        권한:
        `BUYER` 및 `SELLER` 모두 접근 가능

        정렬:
        최신 알림부터 조회 (`createdAt` 내림차순)

        페이지네이션:
        기본값: page=1, pageSize=10

        알림 생성 시점:
        본인 상품에 문의 등록 시
        본인 문의에 답변 등록 시
        본인 상품에 리뷰 등록 시
        기타 시스템 알림

        알림 읽음 처리:
        `isChecked`: false (읽지 않음), true (읽음)
        PATCH /api/notifications/:id/check 엔드포인트로 읽음 처리
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          required: false
          description: 페이지 번호 (1부터 시작)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 1
            example: 1
        - name: pageSize
          in: query
          required: false
          description: 페이지당 항목 수 (기본값 10)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
            example: 10
      responses:
        '200':
          description: 알림 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  list:
                    type: array
                    description: 알림 목록
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          description: 알림 ID
                          example: "cmjtkpx3r001rp701n8q7w2yz"
                        userId:
                          type: string
                          description: 알림 수신자(사용자) ID
                          example: "cmjthpery0003p701k9l2m5xq"
                        content:
                          type: string
                          description: 알림 내용
                          example: "코디잇 오버핏 후드티에 새로운 문의가 등록되었습니다."
                        isChecked:
                          type: boolean
                          description: "읽음 여부 (false: 읽지 않음, true: 읽음)"
                          example: false
                        createdAt:
                          type: string
                          format: date-time
                          description: 알림 생성 일시
                          example: "2025-01-05T10:30:00.000Z"
                        updatedAt:
                          type: string
                          format: date-time
                          description: 알림 수정 일시 (읽음 처리 시 업데이트됨)
                          example: "2025-01-05T10:30:00.000Z"
                  totalCount:
                    type: integer
                    description: 전체 알림 개수
                    example: 42
        '401':
          description: 인증 실패
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "인증이 필요합니다."

  /api/notifications/sse:
    get:
      tags:
        - Notification
      summary: SSE 실시간 알림 연결
      description: |
        Server-Sent Events(SSE)를 통한 실시간 알림 스트리밍 연결을 생성합니다.

        인증 필요:
        `Bearer 토큰 필수`

        권한:
        `BUYER` 및 `SELLER` 모두 접근 가능

        SSE 동작 방식:
        클라이언트가 이 엔드포인트에 연결
        서버가 `text/event-stream` 형식으로 응답 헤더 전송
        연결이 유지되는 동안 실시간으로 알림 전송
        `30초`마다 keep-alive 메시지 전송 (연결 유지)
        클라이언트 연결 종료 시 서버에서 자동으로 정리

        응답 헤더:
        Content-Type: `text/event-stream`
        Cache-Control: `no-cache`
        Connection: `keep-alive`

        이벤트 형식:
        ```
        data: {"id":"cmjtkpx3r001rp701n8q7w2yz","userId":"cmjthpery0003p701k9l2m5xq","content":"새로운 문의가 등록되었습니다.","isChecked":false,"createdAt":"2025-01-05T10:30:00.000Z","updatedAt":"2025-01-05T10:30:00.000Z"}

        ```

        Keep-alive 형식:
        ```
        : keep-alive

        ```

        사용 예시 (JavaScript):
        ```javascript
        const eventSource = new EventSource('/api/notifications/sse', {
          headers: {
            Authorization: 'Bearer YOUR_ACCESS_TOKEN'
          }
        });

        eventSource.onmessage = (event) => {
          const notification = JSON.parse(event.data);
          console.log('새 알림:', notification);
        };

        eventSource.onerror = () => {
          console.error('SSE 연결 오류');
          eventSource.close();
        };
        ```

        주의사항:
        한 사용자당 하나의 SSE 연결만 유지됨
        새 연결 시 기존 연결은 자동으로 종료됨
        네트워크 불안정 시 재연결 로직 필요
      security:
        - bearerAuth: []
      responses:
        '200':
          description: SSE 연결 성공 (스트리밍 시작)
          content:
            text/event-stream:
              schema:
                type: array
                description: |
                  Server-Sent Events 스트림

                  실제 전송 형식:
                  data: JSON 형식의 알림 객체
                  빈 줄로 이벤트 구분

                  Keep-alive 메시지:
                  ": keep-alive" 형식
                  `30초`마다 전송
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      example: "cmjtkpx3r001rp701n8q7w2yz"
                    userId:
                      type: string
                      example: "cmjthpery0003p701k9l2m5xq"
                    content:
                      type: string
                      example: "코디잇 오버핏 후드티에 새로운 문의가 등록되었습니다."
                    isChecked:
                      type: boolean
                      example: false
                    createdAt:
                      type: string
                      format: date-time
                      example: "2025-01-05T10:30:00.000Z"
                    updatedAt:
                      type: string
                      format: date-time
                      example: "2025-01-05T11:00:00.000Z"
                example:
                  - id: "cmjtkpx3r001rp701n8q7w2yz"
                    userId: "cmjthpery0003p701k9l2m5xq"
                    content: "코디잇 오버핏 후드티에 새로운 문의가 등록되었습니다."
                    isChecked: false
                    createdAt: "2025-01-05T10:30:00.000Z"
                    updatedAt: "2025-01-05T10:30:00.000Z"
                  - id: "cmjtkpy5k001tp701z9x3m4pq"
                    userId: "cmjthpery0003p701k9l2m5xq"
                    content: "베이직 면 티셔츠에 새로운 리뷰가 등록되었습니다."
                    isChecked: false
                    createdAt: "2025-01-05T11:00:00.000Z"
                    updatedAt: "2025-01-05T11:00:00.000Z"

        '401':
          description: 인증 실패
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "인증이 필요합니다."

  /api/notifications/{id}/check:
    patch:
      tags:
        - Notification
      summary: 알림 읽음 처리
      description: |
        특정 알림을 읽음 상태로 변경합니다.

        인증 필요:
        `Bearer 토큰 필수`

        권한:
        알림 소유자(`userId`)만 읽음 처리 가능 (다른 사용자의 알림 읽음 시도 시 `403 Forbidden`)

        동작:
        `isChecked`를 `false` → `true`로 변경
        이미 읽음 처리된 알림 호출 시 DB 쿼리 없이 early return (최적화)

        사용 시나리오:
        사용자가 알림을 클릭했을 때
        알림 센터에서 개별 알림을 확인했을 때
        "모두 읽음" 기능 구현 시 (개별 호출 필요)
      parameters:
        - name: id
          in: path
          required: true
          description: 알림 ID (`CUID` 포맷)
          schema:
            type: string
            example: "cmjtkpx3r001rp701n8q7w2yz"
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 알림 읽음 처리 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    description: 알림 ID
                    example: "cmjtkpx3r001rp701n8q7w2yz"
                  userId:
                    type: string
                    description: 알림 수신자 ID
                    example: "cmjthpery0003p701k9l2m5xq"
                  content:
                    type: string
                    description: 알림 내용
                    example: "코디잇 오버핏 후드티에 새로운 문의가 등록되었습니다."
                  isChecked:
                    type: boolean
                    description: 읽음 여부 (항상 true)
                    example: true
                  createdAt:
                    type: string
                    format: date-time
                    description: 알림 생성 일시
                    example: "2025-01-05T10:30:00.000Z"
                  updatedAt:
                    type: string
                    format: date-time
                    description: 알림 수정 일시 (읽음 처리 시점으로 업데이트됨)
                    example: "2025-01-05T15:45:00.000Z"
        '401':
          description: 인증 실패
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "인증이 필요합니다."
        '403':
          description: 권한 없음 (알림 소유자가 아님)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "해당 알림에 대한 접근 권한이 없습니다."
        '404':
          description: 알림을 찾을 수 없음
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "알림을 찾을 수 없습니다."

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT 액세스 토큰 (로그인 후 발급)
