name: Deploy to AWS (Blue-Green)

on:
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° (í…ŒìŠ¤íŠ¸ìš©)
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  deploy:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        run: |
          echo "ğŸ”¨ Building Docker image..."
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
                     $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "ğŸ“¤ Pushing to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "âœ… Image pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

      # ============================================
      # ë¸”ë£¨-ê·¸ë¦° ë°°í¬: í˜„ì¬ í™œì„± í™˜ê²½ ìë™ ê°ì§€
      # ============================================
      - name: Detect current active environment
        id: detect
        run: |
          echo "ğŸ” í˜„ì¬ ìš´ì˜ ì¤‘ì¸ í™˜ê²½ ê°ì§€ ì¤‘..."

          # ALB Listenerê°€ í˜„ì¬ ì–´ëŠ Target Groupì„ ê°€ë¦¬í‚¤ëŠ”ì§€ í™•ì¸
          CURRENT_TG_ARN=$(aws elbv2 describe-listeners \
            --listener-arns ${{ secrets.ALB_LISTENER_ARN }} \
            --query 'Listeners[0].DefaultActions[0].TargetGroupArn' \
            --output text)

          echo "Current Target Group: $CURRENT_TG_ARN"

          # Blue/Green íŒë‹¨ ë° ë°°í¬ íƒ€ê²Ÿ ê²°ì •
          if [[ "$CURRENT_TG_ARN" == "${{ secrets.BLUE_TARGET_GROUP_ARN }}" ]]; then
            # Blue ìš´ì˜ ì¤‘ â†’ Greenì— ë°°í¬
            echo "current_env=blue" >> $GITHUB_OUTPUT
            echo "target_env=green" >> $GITHUB_OUTPUT
            echo "target_host=${{ secrets.GREEN_EC2_HOST }}" >> $GITHUB_OUTPUT
            echo "target_tg_arn=${{ secrets.GREEN_TARGET_GROUP_ARN }}" >> $GITHUB_OUTPUT

            echo "ğŸ“˜ í˜„ì¬: Blue ìš´ì˜ ì¤‘"
            echo "ğŸ“— ë°°í¬ íƒ€ê²Ÿ: Green"

          elif [[ "$CURRENT_TG_ARN" == "${{ secrets.GREEN_TARGET_GROUP_ARN }}" ]]; then
            # Green ìš´ì˜ ì¤‘ â†’ Blueì— ë°°í¬
            echo "current_env=green" >> $GITHUB_OUTPUT
            echo "target_env=blue" >> $GITHUB_OUTPUT
            echo "target_host=${{ secrets.BLUE_EC2_HOST }}" >> $GITHUB_OUTPUT
            echo "target_tg_arn=${{ secrets.BLUE_TARGET_GROUP_ARN }}" >> $GITHUB_OUTPUT

            echo "ğŸ“— í˜„ì¬: Green ìš´ì˜ ì¤‘"
            echo "ğŸ“˜ ë°°í¬ íƒ€ê²Ÿ: Blue"

          else
            echo "âŒ Error: Unknown Target Group"
            echo "Expected: ${{ secrets.BLUE_TARGET_GROUP_ARN }} or ${{ secrets.GREEN_TARGET_GROUP_ARN }}"
            echo "Actual: $CURRENT_TG_ARN"
            exit 1
          fi

          echo "âœ… ë°°í¬ íƒ€ê²Ÿ ê²°ì • ì™„ë£Œ"

      # ============================================
      # ë°°í¬: ê°ì§€ëœ íƒ€ê²Ÿ í™˜ê²½ì— ë°°í¬ (ë™ì )
      # ============================================
      - name: Deploy to ${{ steps.detect.outputs.target_env }} EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ steps.detect.outputs.target_host }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment on ${{ steps.detect.outputs.target_env }} EC2..."

            # ECR ë¡œê·¸ì¸
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
              docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

            # ìƒˆ ì´ë¯¸ì§€ pull
            echo "ğŸ“¥ Pulling new image..."
            docker pull ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ Graceful Shutdown (30ì´ˆ ëŒ€ê¸°)
            echo "ğŸ›‘ Stopping old container (graceful shutdown)..."
            docker stop --time 30 app || true
            docker rm app || true

            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "â–¶ï¸  Starting new container..."
            docker run -d \
              --name app \
              -p 3000:3000 \
              --restart=always \
              --env-file /home/ec2-user/.env \
              ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

            # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ (í—¬ìŠ¤ì²´í¬ ì „)
            echo "ğŸ”„ Running Prisma migrations..."
            docker exec app npx prisma migrate deploy

            if [ $? -ne 0 ]; then
              echo "âŒ Migration failed!"
              echo "ğŸ“‹ Container logs:"
              docker logs app --tail 50
              echo "ğŸ§¹ Cleaning up failed container..."
              docker stop app
              docker rm app
              exit 1
            fi
            echo "âœ… Migrations completed"

            # í—¬ìŠ¤ì²´í¬ (ì¬ì‹œë„ ë¡œì§)
            echo "ğŸ¥ Health checking..."
            for i in {1..12}; do
              if curl -f http://localhost:3000/api/health; then
                echo "âœ… Health check passed! (attempt $i/12)"
                echo "âœ… ${{ steps.detect.outputs.target_env }} EC2 deployment successful!"
                break
              fi

              if [ $i -eq 12 ]; then
                echo "âŒ Health check failed after 60 seconds"
                echo "ğŸ“‹ Container logs:"
                docker logs app --tail 50
                exit 1
              fi

              echo "   â³ Retrying... ($i/12)"
              sleep 5
            done

      # ============================================
      # íŠ¸ë˜í”½ ì „í™˜: ALBë¥¼ ìƒˆ í™˜ê²½ìœ¼ë¡œ ì „í™˜
      # ============================================
      - name: Switch ALB to ${{ steps.detect.outputs.target_env }} Target Group
        if: success()
        run: |
          echo "ğŸ”€ ALB íŠ¸ë˜í”½ ì „í™˜ ì¤‘..."
          echo "   ${{ steps.detect.outputs.current_env }} â†’ ${{ steps.detect.outputs.target_env }}"

          aws elbv2 modify-listener \
            --listener-arn ${{ secrets.ALB_LISTENER_ARN }} \
            --default-actions \
              Type=forward,TargetGroupArn=${{ steps.detect.outputs.target_tg_arn }}

          echo "âœ… íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ!"
          echo ""
          echo "ğŸ“Š ë°°í¬ ê²°ê³¼:"
          echo "   â€¢ ì´ì „ í™˜ê²½: ${{ steps.detect.outputs.current_env }} (ë¡¤ë°± ëŒ€ê¸° ì¤‘)"
          echo "   â€¢ í˜„ì¬ í™˜ê²½: ${{ steps.detect.outputs.target_env }} (ìš´ì˜ ì¤‘)"
          echo "   â€¢ ì´ë¯¸ì§€: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}"
          echo ""
          echo "ğŸ‰ ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì™„ë£Œ!"

      # ============================================
      # ì •ë¦¬: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì‚­ì œ
      # (íŠ¸ë˜í”½ ì „í™˜ í›„ ì‹¤í–‰ â†’ í˜„ì¬ ìš´ì˜ ì´ë¯¸ì§€ ë³´í˜¸)
      # ============================================
      - name: Cleanup old Docker images on ${{ steps.detect.outputs.target_env }} EC2
        if: success()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ steps.detect.outputs.target_host }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ§¹ Cleaning up unused Docker images..."
            docker image prune -af --filter "until=24h"
            echo "âœ… Cleanup completed"

      # ============================================
      # ë¡¤ë°±: ë°°í¬ ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ í™˜ê²½ ìœ ì§€
      # ============================================
      - name: Rollback on failure
        if: failure()
        run: |
          echo "âŒ ${{ steps.detect.outputs.target_env }} ë°°í¬ ì‹¤íŒ¨!"
          echo "ğŸ’¡ ${{ steps.detect.outputs.current_env }} í™˜ê²½ì´ ê³„ì† ìš´ì˜ ì¤‘ì…ë‹ˆë‹¤."
          echo ""
          echo "ğŸ”„ ë¡¤ë°± ë¶ˆí•„ìš” (ALB ì „í™˜ ì „ ì‹¤íŒ¨)"
          echo "   â†’ ì‚¬ìš©ì íŠ¸ë˜í”½ì€ ${{ steps.detect.outputs.current_env }}ë¡œ ê³„ì† ìœ ì…ë©ë‹ˆë‹¤."
